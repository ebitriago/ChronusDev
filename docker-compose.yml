version: '3.8'

services:
  # ==========================================================
  # CHRONUSDEV BACKEND (API Principal - Project Management)
  # ==========================================================
  chronusdev-backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    container_name: chronusdev-backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET:-chronusdev-super-secret-change-me-in-production}
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - chronus-network

  # ==========================================================
  # CHRONUSDEV FRONTEND (Next.js - Project Management UI)
  # ==========================================================
  chronusdev-frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${CHRONUSDEV_API_URL:-http://chronusdev-backend:3001}
    container_name: chronusdev-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${CHRONUSDEV_API_URL:-http://chronusdev-backend:3001}
    depends_on:
      chronusdev-backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chronus-network

  # ==========================================================
  # CHRONUSCRM BACKEND (API CRM + Socket.io + AssistAI)
  # ==========================================================
  chronuscrm-backend:
    build:
      context: .
      dockerfile: apps/crm/Dockerfile
    container_name: chronuscrm-backend
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      # Integration with ChronusDev
      - CHRONUSDEV_URL=http://chronusdev-backend:3001
      - CHRONUSDEV_TOKEN=${CHRONUSDEV_TOKEN:-token-admin-123}
      # AssistAI Integration
      - ASSISTAI_API_URL=${ASSISTAI_API_URL:-https://public.assistai.lat}
      - ASSISTAI_API_TOKEN=${ASSISTAI_API_TOKEN}
      - ASSISTAI_TENANT_DOMAIN=${ASSISTAI_TENANT_DOMAIN}
      - ASSISTAI_ORG_CODE=${ASSISTAI_ORG_CODE}
    depends_on:
      chronusdev-backend:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - chronus-network

  # ==========================================================
  # CHRONUSCRM FRONTEND (Next.js - CRM UI + Live Chat)
  # ==========================================================
  chronuscrm-frontend:
    build:
      context: .
      dockerfile: apps/crm-frontend/Dockerfile
      args:
        - NEXT_PUBLIC_CRM_API_URL=${CHRONUSCRM_API_URL:-http://chronuscrm-backend:3002}
    container_name: chronuscrm-frontend
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - NEXT_PUBLIC_CRM_API_URL=${CHRONUSCRM_API_URL:-http://chronuscrm-backend:3002}
    depends_on:
      chronuscrm-backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chronus-network

# ==========================================================
# NETWORK (Shared network for all services)
# ==========================================================
networks:
  chronus-network:
    name: chronus-network
    driver: bridge
