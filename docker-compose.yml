version: '3.8'

services:
  # ==========================================================
  # CHRONUSDEV BACKEND (API Principal - Project Management)
  # ==========================================================


  # ==========================================================
  # CHRONUSDEV FRONTEND (Next.js - Project Management UI)
  # ==========================================================
  chronusdev-frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${CHRONUSDEV_FRONTEND_API_URL:-/api}
    container_name: chronusdev-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${CHRONUSDEV_FRONTEND_API_URL:-/api}
      - CRM_BACKEND_INTERNAL_URL=http://chronuscrm-backend:3002
    depends_on:
      chronuscrm-backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chronus-network

  # ==========================================================
  # CHRONUSCRM BACKEND (API CRM + Socket.io + AssistAI)
  # ==========================================================
  chronuscrm-backend:
    build:
      context: apps/crm
      dockerfile: Dockerfile
    container_name: chronuscrm-backend
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      # Integration with ChronusDev
      - CHRONUSDEV_URL=${CHRONUSDEV_URL:-http://chronuscrm-backend:3002}
      - CHRONUSDEV_TOKEN=${CHRONUSDEV_TOKEN:-token-admin-123}
      - CRM_FRONTEND_URL=${CRM_FRONTEND_URL:-http://localhost:3003}
      # AssistAI Integration
      - ASSISTAI_API_URL=${ASSISTAI_API_URL:-https://public.assistai.lat}
      - ASSISTAI_API_TOKEN=${ASSISTAI_API_TOKEN}
      - ASSISTAI_TENANT_DOMAIN=${ASSISTAI_TENANT_DOMAIN}
      - ASSISTAI_ORG_CODE=${ASSISTAI_ORG_CODE}
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - chronus-network

  # ==========================================================
  # CHRONUSCRM FRONTEND (Next.js - CRM UI + Live Chat)
  # ==========================================================
  chronuscrm-frontend:
    build:
      context: .
      dockerfile: apps/crm-frontend/Dockerfile
      args:
        # Use relative /api to go through Next.js proxy
        - NEXT_PUBLIC_CRM_API_URL=${CHRONUSCRM_API_URL:-/api}
        - NEXT_PUBLIC_API_URL=${CHRONUSDEV_API_URL:-http://localhost:3001}
    container_name: chronuscrm-frontend
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      # Internal URL for checking backend status inside container if needed
      - CRM_BACKEND_INTERNAL_URL=http://chronuscrm-backend:3002
      # Public URL for browser is relative
      - NEXT_PUBLIC_CRM_API_URL=${CHRONUSCRM_API_URL:-/api}
      - NEXT_PUBLIC_API_URL=${CHRONUSDEV_API_URL:-/api}
    depends_on:
      chronuscrm-backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chronus-network

# ==========================================================
# NETWORK (Shared network for all services)
# ==========================================================
networks:
  chronus-network:
    name: chronus-network
    driver: bridge
