
> @chronusdev/crm@0.1.0 test
> NODE_OPTIONS=--experimental-vm-modules jest --no-cache

FAIL src/services/__tests__/assistai.test.ts
  ‚óè Test suite failed to run

    ReferenceError: jest is not defined

      4 |
      5 | // Mock Prisma
    > 6 | jest.mock('../../db.js', () => ({
        | ^
      7 |     prisma: {
      8 |         conversation: {
      9 |             upsert: jest.fn(),

      at src/services/__tests__/assistai.test.ts:6:1

(node:39686) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL src/jobs/__tests__/assistai-sync.test.ts
  ‚óè Test suite failed to run

    ReferenceError: jest is not defined

       6 |
       7 | // Mocks
    >  8 | jest.mock('node-cron', () => ({
         | ^
       9 |     schedule: jest.fn((cron, callback) => {
      10 |         // Immediately invoke callback for testing
      11 |         callback();

      at src/jobs/__tests__/assistai-sync.test.ts:8:1

(node:39689) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:39687) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:39688) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:39684) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:39691) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:39690) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/proposals.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      [Auth] Request: POST /leads

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /invoices

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /invoices/cml6xszf00001ttv0si9boq1m/convert

      at authMiddleware (src/auth.ts:63:13)

  ‚óè Lead Proposals API ‚Ä∫ should create a quote (proposal) linked to a lead

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

      44 |             .send(proposalData);
      45 |
    > 46 |         expect(res.status).toBe(201);
         |                            ^
      47 |         expect(res.body.leadId).toBe(testLeadId);
      48 |         expect(res.body.type).toBe('QUOTE');
      49 |         expect(res.body.amount).toBe(500);

      at Object.<anonymous> (tests/proposals.test.ts:46:28)

  ‚óè Lead Proposals API ‚Ä∫ should convert a quote to an invoice

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      62 |             .set('Authorization', `Bearer ${token}`);
      63 |
    > 64 |         expect(res.status).toBe(200);
         |                            ^
      65 |         expect(res.body.type).toBe('INVOICE');
      66 |         expect(res.body.number).toMatch(/^INV-/);
      67 |     });

      at Object.<anonymous> (tests/proposals.test.ts:64:28)

FAIL tests/reports_csv.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      [Auth] Request: GET /reports/export/invoices-csv

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /reports/export/transactions-csv

      at authMiddleware (src/auth.ts:63:13)

  ‚óè CSV Export API ‚Ä∫ should export invoices as CSV

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      17 |             .set('Authorization', `Bearer ${token}`);
      18 |
    > 19 |         expect(res.status).toBe(200);
         |                            ^
      20 |         expect(res.header['content-type']).toContain('text/csv');
      21 |         expect(res.header['content-disposition']).toContain('attachment; filename="invoices.csv"');
      22 |         expect(res.text).toContain('ID,Number,Customer,Amount,Currency,Status,Date');

      at Object.<anonymous> (tests/reports_csv.test.ts:19:28)

  ‚óè CSV Export API ‚Ä∫ should export transactions as CSV

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      28 |             .set('Authorization', `Bearer ${token}`);
      29 |
    > 30 |         expect(res.status).toBe(200);
         |                            ^
      31 |         expect(res.header['content-type']).toContain('text/csv');
      32 |         expect(res.header['content-disposition']).toContain('attachment; filename="transactions.csv"');
      33 |         expect(res.text).toContain('ID,Date,Description,Category,Type,Amount,Customer');

      at Object.<anonymous> (tests/reports_csv.test.ts:30:28)

(node:39685) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:39692) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/smtp.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      [Auth] Request: POST /settings/smtp

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /settings/smtp

      at authMiddleware (src/auth.ts:63:13)

  ‚óè SMTP Configuration API ‚Ä∫ should save SMTP configuration

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      27 |             .send(smtpConfig);
      28 |
    > 29 |         expect(res.status).toBe(200);
         |                            ^
      30 |         expect(res.body.success).toBe(true);
      31 |     });
      32 |

      at Object.<anonymous> (tests/smtp.test.ts:29:28)

  ‚óè SMTP Configuration API ‚Ä∫ should retrieve SMTP configuration

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      36 |             .set('Authorization', `Bearer ${token}`);
      37 |
    > 38 |         expect(res.status).toBe(200);
         |                            ^
      39 |         expect(res.body.host).toBe('smtp.test.com');
      40 |         expect(res.body.user).toBe('test-user');
      41 |     });

      at Object.<anonymous> (tests/smtp.test.ts:38:28)

PASS tests/erp-products.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /erp/products

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/products

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /erp/products

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /erp/products/cmlfdg97x0003103eidh2gxpy

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /erp/products/cmlfdg97x0003103eidh2gxpy

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: DELETE /erp/products/cmlfdg97x0003103eidh2gxpy

      at authMiddleware (src/auth.ts:63:13)

PASS tests/erp-orders.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /erp/orders

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/orders

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/orders

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/orders/cml7e5dqw0003kj0wu0ms82rk

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/orders

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /erp/orders/cml7e5dqw0003kj0wu0ms82rk

      at authMiddleware (src/auth.ts:63:13)

PASS tests/tickets.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /tickets

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /tickets

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /tickets

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /tickets/cmlfdg9ad00034lug5wm24jen

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /tickets/cmlfdg9ad00034lug5wm24jen

      at authMiddleware (src/auth.ts:63:13)

PASS tests/customers.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Sync] Syncing customer cmlfdg97s0003qrmoourirwkq to ChronusDev via webhook

      at syncCustomerToChronusDev (src/services/chronusdev-sync.ts:35:13)

    console.log
      [Auth] Request: POST /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /customers/cmlfdg97s0003qrmoourirwkq

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /customers/cmlfdg97s0003qrmoourirwkq

      at authMiddleware (src/auth.ts:63:13)

    console.error
      [Sync] Error syncing customer cmlfdg97s0003qrmoourirwkq: Error: Failed to sync client to ChronusDev: {"error":"\nInvalid `prisma.client.create()` invocation in\n/Users/eduardobitriagoe/ChronusDev-1/apps/backend/src/services/crm-sync.ts:53:40\n\n  50     return updated;\n  51 }\n  52 \n‚Üí 53 const client = await prisma.client.create(\nForeign key constraint failed on the field: `Client_organizationId_fkey (index)`"}
          at syncCustomerToChronusDev (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/services/chronusdev-sync.ts:59:19)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)

      72 |         return { clientId };
      73 |     } catch (error) {
    > 74 |         console.error(`[Sync] Error syncing customer ${customer.id}:`, error);
         |                 ^
      75 |         throw error;
      76 |     }
      77 | }

      at syncCustomerToChronusDev (src/services/chronusdev-sync.ts:74:17)

    console.error
      [Sync] Error syncing customer to ChronusDev: Error: Failed to sync client to ChronusDev: {"error":"\nInvalid `prisma.client.create()` invocation in\n/Users/eduardobitriagoe/ChronusDev-1/apps/backend/src/services/crm-sync.ts:53:40\n\n  50     return updated;\n  51 }\n  52 \n‚Üí 53 const client = await prisma.client.create(\nForeign key constraint failed on the field: `Client_organizationId_fkey (index)`"}
          at syncCustomerToChronusDev (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/services/chronusdev-sync.ts:59:19)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)

      255 |         // Sync to ChronusDev
      256 |         syncCustomerToChronusDev(customer as any, organizationId).catch(err =>
    > 257 |             console.error('[Sync] Error syncing customer to ChronusDev:', err)
          |                     ^
      258 |         );
      259 |
      260 |         res.status(201).json(customer);

      at src/routes/customers.ts:257:21

    console.log
      [Auth] Request: DELETE /customers/cmlfdg97s0003qrmoourirwkq

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: DELETE /customers/non-existent-id-12345

      at authMiddleware (src/auth.ts:63:13)

    console.log
      prisma:error 
      Invalid `prisma.customer.delete()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/routes/customers.ts:373:37
      
        370 const organizationId = req.user?.organizationId;
        371 const { id } = req.params;
        372 
      ‚Üí 373 await prisma.customer.delete(
      An operation failed because it depends on one or more records that were required but not found. Record to delete does not exist.

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.error
      DELETE /customers/:id error: PrismaClientKnownRequestError: 
      Invalid `prisma.customer.delete()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/routes/customers.ts:373:37
      
        370 const organizationId = req.user?.organizationId;
        371 const { id } = req.params;
        372 
      ‚Üí 373 await prisma.customer.delete(
      An operation failed because it depends on one or more records that were required but not found. Record to delete does not exist.
          at Ln.handleRequestError (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/node_modules/@prisma/client/runtime/library.js:121:7753)
          at Ln.handleAndLogRequestError (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/node_modules/@prisma/client/runtime/library.js:121:7061)
          at Ln.request (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/node_modules/@prisma/client/runtime/library.js:121:6745)
          at l (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/node_modules/@prisma/client/runtime/library.js:130:9633)
          at /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/routes/customers.ts:373:9 {
        code: 'P2025',
        clientVersion: '5.19.1',
        meta: { modelName: 'Customer', cause: 'Record to delete does not exist.' }
      }

      377 |         res.json({ success: true });
      378 |     } catch (e: any) {
    > 379 |         console.error("DELETE /customers/:id error:", e);
          |                 ^
      380 |         res.status(500).json({ error: e.message });
      381 |     }
      382 | });

      at src/routes/customers.ts:379:17

FAIL tests/webhook.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [AssistAI Webhook] ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'Webhook Test Customer', phone: '5559999999' },
        cart: { total: 199.99, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:351:13

    console.log
      [AssistAI Webhook] Processing ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'Webhook Test Customer', phone: '5559999999' },
        cart: { total: 199.99, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:360:21

    console.log
      [AssistAI Webhook] Auto-creating missing product: WEBHOOK-TEST-SKU-1770653625353

      at src/routes/assistai.ts:409:29

    console.log
      ‚úÖ Created Order from AssistAI Webhook: cmlfdg9b00005t1gctxll3vcl

      at src/routes/assistai.ts:443:21

    console.log
      [AssistAI Webhook] ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'Auto Create Test', phone: '5551111111' },
        cart: { total: 99.99, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:351:13

    console.log
      [AssistAI Webhook] Processing ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'Auto Create Test', phone: '5551111111' },
        cart: { total: 99.99, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:360:21

    console.log
      [AssistAI Webhook] Auto-creating missing product: AUTO-CREATE-1770653625380

      at src/routes/assistai.ts:409:29

    console.log
      ‚úÖ Created Order from AssistAI Webhook: cmlfdg9bg000bt1gc8h4zqkn6

      at src/routes/assistai.ts:443:21

    console.log
      [Auth] Request: GET /erp/products

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [AssistAI Webhook] ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'New Customer From Webhook', phone: '5550005406' },
        cart: { total: 50, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:351:13

    console.log
      [AssistAI Webhook] Processing ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'New Customer From Webhook', phone: '5550005406' },
        cart: { total: 50, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:360:21

    console.log
      ‚úÖ Created Order from AssistAI Webhook: cmlfdg9c6000ht1gc8pwjtluo

      at src/routes/assistai.ts:443:21

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

  ‚óè AssistAI Webhook API ‚Ä∫ POST /assistai/webhook ‚Ä∫ should auto-create product if SKU not found

    expect(received).toBeDefined()

    Received: undefined

      77 |             const autoProduct = productsRes.body.find((p: any) => p.sku === uniqueSku);
      78 |
    > 79 |             expect(autoProduct).toBeDefined();
         |                                 ^
      80 |             expect(autoProduct.name).toBe('Auto Created Product by Webhook');
      81 |         });
      82 |

      at Object.<anonymous> (tests/webhook.test.ts:79:33)

  ‚óè AssistAI Webhook API ‚Ä∫ POST /assistai/webhook ‚Ä∫ should create new customer if phone not found

    expect(received).toBeDefined()

    Received: undefined

      112 |             const newCustomer = customersRes.body.find((c: any) => c.phone === uniquePhone);
      113 |
    > 114 |             expect(newCustomer).toBeDefined();
          |                                 ^
      115 |             expect(newCustomer.name).toBe('New Customer From Webhook');
      116 |         });
      117 |

      at Object.<anonymous> (tests/webhook.test.ts:114:33)

PASS tests/auth.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

PASS tests/health.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "‚úÖ [DB] Successfully connected to PostgreSQL".

      24 | // Test connection
      25 | prisma.$connect()
    > 26 |     .then(() => console.log('‚úÖ [DB] Successfully connected to PostgreSQL'))
         |                         ^
      27 |     .catch((e: any) => console.error('‚ùå [DB] Connection failed:', e));
      28 |
      29 | if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;

      at console.log (node_modules/@jest/console/build/index.js:147:10)
      at src/db.ts:26:25

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.

Test Suites: 6 failed, 6 passed, 12 total
Tests:       8 failed, 30 passed, 38 total
Snapshots:   0 total
Time:        4.652 s
Ran all test suites.
