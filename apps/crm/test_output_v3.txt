
> @chronusdev/crm@0.1.0 test
> NODE_OPTIONS=--experimental-vm-modules jest --no-cache

(node:40643) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:40638) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL src/services/__tests__/assistai.test.ts
  ‚óè Console

    console.log
      [AssistAI] Fetching agents...

      at Object.getAgents (src/services/assistai.ts:113:17)

  ‚óè AssistAIService ‚Ä∫ should send message successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "/conversation/uuid-1/messages", ObjectContaining {"body": StringContaining "Admin User", "method": "POST"}
    Received: "https://api.assistai.lat/api/v1/conversations/uuid-1/messages", {"body": "{\"content\":\"Hello from Human\",\"senderMetadata\":{\"id\":0,\"email\":\"system@chronus.com\",\"firstname\":\"Admin User\",\"lastname\":\"Bot\",\"role\":\"assistant\"},\"intervention\":false}", "headers": {"Authorization": "Bearer test-token", "Content-Type": "application/json", "x-organization-code": "test-org", "x-tenant-domain": "test-domain"}, "method": "POST"}

    Number of calls: 1

      103 |         const result = await AssistAIService.sendMessage(mockConfig, 'uuid-1', 'Hello from Human', 'Admin User');
      104 |
    > 105 |         expect(global.fetch).toHaveBeenCalledWith(
          |                              ^
      106 |             expect.stringContaining('/conversation/uuid-1/messages'),
      107 |             expect.objectContaining({
      108 |                 method: 'POST',

      at Object.<anonymous> (src/services/__tests__/assistai.test.ts:105:30)

FAIL src/jobs/__tests__/assistai-sync.test.ts
  ‚óè Console

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Job] Synced 5 conversations for Org org-1

      at syncForOrganization (src/jobs/assistai-sync.ts:64:21)

    console.log
      [Job] Synced 5 conversations for Org org-2

      at syncForOrganization (src/jobs/assistai-sync.ts:64:21)

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

  ‚óè AssistAI Sync Job ‚Ä∫ should schedule cron job and sync for active organizations

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
        "where": Object {
    -     "status": "ACTIVE",
    +     "subscriptionStatus": "ACTIVE",
        },
      },

    Number of calls: 1

      59 |
      60 |         // Verify Logic Execution
    > 61 |         expect(mockFindManyOrg).toHaveBeenCalledWith({ where: { status: 'ACTIVE' } });
         |                                 ^
      62 |         expect(mockGetAssistAIConfig).toHaveBeenCalledTimes(2);
      63 |         expect(mockSyncRecentConversations).toHaveBeenCalledTimes(2);
      64 |         expect(mockSyncRecentConversations).toHaveBeenCalledWith(

      at Object.<anonymous> (src/jobs/__tests__/assistai-sync.test.ts:61:33)

(node:40639) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:40642) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:40645) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:40646) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:40644) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:40641) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:40640) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS tests/proposals.test.ts (5.932 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: POST /leads

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Automations] Checking rules for Lead cmlffvwhk0003w9nu10cft5ti -> NEW

      at checkLeadAutomations (src/automations.ts:4:13)

    console.log
      [Auth] Request: POST /invoices

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /invoices/cmlffvwia0005w9nu75f3vrjh/convert

      at authMiddleware (src/auth.ts:63:13)

PASS tests/smtp.test.ts (5.313 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: POST /settings/smtp

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /settings/smtp

      at authMiddleware (src/auth.ts:63:13)

PASS tests/erp-orders.test.ts (5.959 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /erp/orders

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/orders

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/orders

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/orders/cml7e5dqw0003kj0wu0ms82rk

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/orders

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /erp/orders/cml7e5dqw0003kj0wu0ms82rk

      at authMiddleware (src/auth.ts:63:13)

PASS tests/auth.test.ts (5.961 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

PASS tests/erp-products.test.ts (5.973 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /erp/products

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /erp/products

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /erp/products

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /erp/products/cmlffvwje0003jx4jsohhotfr

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /erp/products/cmlffvwje0003jx4jsohhotfr

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: DELETE /erp/products/cmlffvwje0003jx4jsohhotfr

      at authMiddleware (src/auth.ts:63:13)

PASS tests/reports_csv.test.ts (5.514 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /reports/export/invoices-csv

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /reports/export/transactions-csv

      at authMiddleware (src/auth.ts:63:13)

PASS tests/tickets.test.ts (6.038 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /tickets

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /tickets

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /tickets

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /tickets/cmlffvwkw000310o35tbej4xg

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /tickets/cmlffvwkw000310o35tbej4xg

      at authMiddleware (src/auth.ts:63:13)

PASS tests/customers.test.ts (6.078 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: POST /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Sync] Syncing customer cmlffvwl5000311m5bm6bdo9z to ChronusDev via webhook

      at syncCustomerToChronusDev (src/services/chronusdev-sync.ts:35:13)

    console.log
      [Auth] Request: POST /customers

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /customers/cmlffvwl5000311m5bm6bdo9z

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: PUT /customers/cmlffvwl5000311m5bm6bdo9z

      at authMiddleware (src/auth.ts:63:13)

    console.error
      [Sync] Error syncing customer cmlffvwl5000311m5bm6bdo9z: Error: Failed to sync client to ChronusDev: {"error":"\nInvalid `prisma.client.create()` invocation in\n/Users/eduardobitriagoe/ChronusDev-1/apps/backend/src/services/crm-sync.ts:53:40\n\n  50     return updated;\n  51 }\n  52 \n‚Üí 53 const client = await prisma.client.create(\nForeign key constraint failed on the field: `Client_organizationId_fkey (index)`"}
          at syncCustomerToChronusDev (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/services/chronusdev-sync.ts:59:19)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)

      72 |         return { clientId };
      73 |     } catch (error) {
    > 74 |         console.error(`[Sync] Error syncing customer ${customer.id}:`, error);
         |                 ^
      75 |         throw error;
      76 |     }
      77 | }

      at syncCustomerToChronusDev (src/services/chronusdev-sync.ts:74:17)

    console.error
      [Sync] Error syncing customer to ChronusDev: Error: Failed to sync client to ChronusDev: {"error":"\nInvalid `prisma.client.create()` invocation in\n/Users/eduardobitriagoe/ChronusDev-1/apps/backend/src/services/crm-sync.ts:53:40\n\n  50     return updated;\n  51 }\n  52 \n‚Üí 53 const client = await prisma.client.create(\nForeign key constraint failed on the field: `Client_organizationId_fkey (index)`"}
          at syncCustomerToChronusDev (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/services/chronusdev-sync.ts:59:19)
          at processTicksAndRejections (node:internal/process/task_queues:103:5)

      255 |         // Sync to ChronusDev
      256 |         syncCustomerToChronusDev(customer as any, organizationId).catch(err =>
    > 257 |             console.error('[Sync] Error syncing customer to ChronusDev:', err)
          |                     ^
      258 |         );
      259 |
      260 |         res.status(201).json(customer);

      at src/routes/customers.ts:257:21

    console.log
      [Auth] Request: DELETE /customers/cmlffvwl5000311m5bm6bdo9z

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [Auth] Request: DELETE /customers/non-existent-id-12345

      at authMiddleware (src/auth.ts:63:13)

    console.log
      prisma:error 
      Invalid `prisma.customer.delete()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/routes/customers.ts:373:37
      
        370 const organizationId = req.user?.organizationId;
        371 const { id } = req.params;
        372 
      ‚Üí 373 await prisma.customer.delete(
      An operation failed because it depends on one or more records that were required but not found. Record to delete does not exist.

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.error
      DELETE /customers/:id error: PrismaClientKnownRequestError: 
      Invalid `prisma.customer.delete()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/routes/customers.ts:373:37
      
        370 const organizationId = req.user?.organizationId;
        371 const { id } = req.params;
        372 
      ‚Üí 373 await prisma.customer.delete(
      An operation failed because it depends on one or more records that were required but not found. Record to delete does not exist.
          at Ln.handleRequestError (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/node_modules/@prisma/client/runtime/library.js:121:7753)
          at Ln.handleAndLogRequestError (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/node_modules/@prisma/client/runtime/library.js:121:7061)
          at Ln.request (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/node_modules/@prisma/client/runtime/library.js:121:6745)
          at l (/Users/eduardobitriagoe/ChronusDev-1/apps/crm/node_modules/@prisma/client/runtime/library.js:130:9633)
          at /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/routes/customers.ts:373:9 {
        code: 'P2025',
        clientVersion: '5.19.1',
        meta: { modelName: 'Customer', cause: 'Record to delete does not exist.' }
      }

      377 |         res.json({ success: true });
      378 |     } catch (e: any) {
    > 379 |         console.error("DELETE /customers/:id error:", e);
          |                 ^
      380 |         res.status(500).json({ error: e.message });
      381 |     }
      382 | });

      at src/routes/customers.ts:379:17

FAIL tests/webhook.test.ts (6.165 s)
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)

    console.log
      ‚úÖ [DB] Successfully connected to PostgreSQL

      at src/db.ts:26:25

    console.log
      prisma:error 
      Invalid `prisma.session.create()` invocation in
      /Users/eduardobitriagoe/ChronusDev-1/apps/crm/src/auth.ts:270:30
      
        267 expiresAt.setDate(expiresAt.getDate() + 7);
        268 
        269 try {
      ‚Üí 270     await prisma.session.create(
      Unique constraint failed on the fields: (`token`)

      at Object.rc (node_modules/@prisma/client/runtime/library.js:21:432)

    console.log
      [AssistAI Webhook] ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'Webhook Test Customer', phone: '5559999999' },
        cart: { total: 199.99, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:351:13

    console.log
      [AssistAI Webhook] Processing ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'Webhook Test Customer', phone: '5559999999' },
        cart: { total: 199.99, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:360:21

    console.log
      [AssistAI Webhook] Auto-creating missing product: WEBHOOK-TEST-SKU-1770657714621

      at src/routes/assistai.ts:409:29

    console.log
      ‚úÖ Created Order from AssistAI Webhook: cmlffvwly000556sohz3n2o1m

      at src/routes/assistai.ts:443:21

    console.log
      [AssistAI Webhook] ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'Auto Create Test', phone: '5551111111' },
        cart: { total: 99.99, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:351:13

    console.log
      [AssistAI Webhook] Processing ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'Auto Create Test', phone: '5551111111' },
        cart: { total: 99.99, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:360:21

    console.log
      [AssistAI Webhook] Auto-creating missing product: AUTO-CREATE-1770657714658

      at src/routes/assistai.ts:409:29

    console.log
      ‚úÖ Created Order from AssistAI Webhook: cmlffvwmq000b56sos9n2wi9j

      at src/routes/assistai.ts:443:21

    console.log
      [Auth] Request: GET /erp/products

      at authMiddleware (src/auth.ts:63:13)

    console.log
      [AssistAI Webhook] ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'New Customer From Webhook', phone: '5550004706' },
        cart: { total: 50, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:351:13

    console.log
      [AssistAI Webhook] Processing ORDER_CREATED {
        agentCode: 'TEST_AGENT',
        customer: { name: 'New Customer From Webhook', phone: '5550004706' },
        cart: { total: 50, items: [ [Object] ] }
      }

      at src/routes/assistai.ts:360:21

    console.log
      ‚úÖ Created Order from AssistAI Webhook: cmlffvwo5000h56sokvkbzwn0

      at src/routes/assistai.ts:443:21

    console.log
      [Auth] Request: GET /customers

      at authMiddleware (src/auth.ts:63:13)

  ‚óè AssistAI Webhook API ‚Ä∫ POST /assistai/webhook ‚Ä∫ should auto-create product if SKU not found

    expect(received).toBeDefined()

    Received: undefined

      77 |             const autoProduct = productsRes.body.find((p: any) => p.sku === uniqueSku);
      78 |
    > 79 |             expect(autoProduct).toBeDefined();
         |                                 ^
      80 |             expect(autoProduct.name).toBe('Auto Created Product by Webhook');
      81 |         });
      82 |

      at Object.<anonymous> (tests/webhook.test.ts:79:33)

  ‚óè AssistAI Webhook API ‚Ä∫ POST /assistai/webhook ‚Ä∫ should create new customer if phone not found

    expect(received).toBeDefined()

    Received: undefined

      112 |             const newCustomer = customersRes.body.find((c: any) => c.phone === uniquePhone);
      113 |
    > 114 |             expect(newCustomer).toBeDefined();
          |                                 ^
      115 |             expect(newCustomer.name).toBe('New Customer From Webhook');
      116 |         });
      117 |

      at Object.<anonymous> (tests/webhook.test.ts:114:33)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "[Automations] Stage 'NEW' not found for org cml307egh000301pd2qvjtaga".

      28 |
      29 |         if (!stage) {
    > 30 |             console.log(`[Automations] Stage '${newStatus}' not found for org ${lead.organizationId}`);
         |                     ^
      31 |             return;
      32 |         }
      33 |

      at console.log (node_modules/@jest/console/build/index.js:147:10)
      at checkLeadAutomations (src/automations.ts:30:21)

PASS tests/health.test.ts
  ‚óè Console

    console.log
      üîå [DB] Connecting to: postgresql://postgres:****@localhost:5434/chronuscrm?schema=public

      at src/db.ts:12:9

    console.log
      [Job] Starting AssistAI Sync Job (Every 1 minute)...

      at startAssistAISyncJob (src/jobs/assistai-sync.ts:15:13)

    console.log
      [Scheduler] Initialized. Polling for scheduled interactions every minute...

      at initScheduler (src/scheduler.ts:9:13)

    console.log
      [ReminderScheduler] Initialized. Checking for reminders daily at 8:00 AM...

      at initReminderScheduler (src/reminderScheduler.ts:10:13)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "‚úÖ [DB] Successfully connected to PostgreSQL".

      24 | // Test connection
      25 | prisma.$connect()
    > 26 |     .then(() => console.log('‚úÖ [DB] Successfully connected to PostgreSQL'))
         |                         ^
      27 |     .catch((e: any) => console.error('‚ùå [DB] Connection failed:', e));
      28 |
      29 | if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;

      at console.log (node_modules/@jest/console/build/index.js:147:10)
      at src/db.ts:26:25

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.

Test Suites: 3 failed, 9 passed, 12 total
Tests:       4 failed, 38 passed, 42 total
Snapshots:   0 total
Time:        7.699 s
Ran all test suites.
