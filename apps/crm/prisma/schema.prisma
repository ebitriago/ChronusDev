generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                   @id @default(cuid())
  email               String                   @unique
  password            String?
  name                String
  role                Role                     @default(AGENT)
  avatar              String?
  phone               String?
  assistaiId          String?                  @unique
  assistaiToken       String?
  googleAccessToken   String?
  googleRefreshToken  String?
  googleCalendarEmail String?
  googleTokenExpiry   BigInt?
  resetToken          String?                  @unique
  resetTokenExpires   DateTime?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  lastLoginAt         DateTime?
  activities          Activity[]
  calendarEvents      CalendarEvent[]
  integrations        Integration[]
  assignedLeads       Lead[]                   @relation("AssignedLeads")
  createdLeads        Lead[]                   @relation("CreatedLeads")
  notifications       Notification[]
  notifPrefs          NotificationPreferences?
  memberships         OrganizationMember[]
  createdPayouts      Payout[]                 @relation("CreatedPayouts")
  payouts             Payout[]
  projects            ProjectMember[]
  pushDevices         PushDevice[]
  sessions            Session[]
  assignedTasks       Task[]                   @relation("AssignedTasks")
  createdTasks        Task[]                   @relation("CreatedTasks")
  taskComments        TaskComment[]
  assignedTickets     Ticket[]                 @relation("AssignedTickets")
  createdTickets      Ticket[]                 @relation("CreatedTickets")
  ticketComments      TicketComment[]
  timeLogs            TimeLog[]
  aiAgents            AiAgent[]                @relation("AiAgentToUser")

  @@index([email])
  @@index([assistaiId])
}

model Organization {
  id                 String                    @id @default(cuid())
  name               String
  slug               String                    @unique
  assistaiConfig     Json?
  smtpConfig         Json?
  enabledServices    String                    @default("CRM,CHRONUSDEV,ASSISTAI")
  plan               String                    @default("FREE")
  subscriptionStatus String                    @default("ACTIVE")
  stripeCustomerId   String?
  billingEmail       String?
  trialEndsAt        DateTime?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  activities         Activity[]
  aiAgents           AiAgent[]
  apiKeys            ApiKey[]
  billingInvoices    BillingInvoice[]
  channels           Channel[]
  communications     Communication[]
  contacts           Contact[]
  conversations      Conversation[]
  customers          Customer[]
  integrations       Integration[]
  invoices           Invoice[]
  leads              Lead[]
  notifications      Notification[]
  notifPrefs         NotificationPreferences[]
  members            OrganizationMember[]
  payouts            Payout[]
  pipelineStages     PipelineStage[]
  projects           Project[]
  pushDevices        PushDevice[]
  reminderTemplates  ReminderTemplate[]
  tags               Tag[]
  takeovers          Takeover[]
  tickets            Ticket[]
  transactions       Transaction[]
  webhookEndpoints   WebhookEndpoint[]
  shoppingCarts      AssistantShoppingCart[]
  globalProducts     GlobalProduct[]
  marketSegments     MarketSegment[]
  campaigns          Campaign[]
  reminders          Reminder[]
}

model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           Role         @default(AGENT)
  defaultPayRate Float        @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Customer {
  id                         String                  @id @default(cuid())
  name                       String
  email                      String
  phone                      String?
  company                    String?
  plan                       Plan                    @default(FREE)
  status                     CustomerStatus          @default(TRIAL)
  monthlyRevenue             Float                   @default(0)
  currency                   String                  @default("USD")
  notes                      String?
  customFields               Json?
  taxId                      String?
  address                    String?
  billingAddress             String?
  paymentTerms               String?
  chronusDevClientId         String?
  chronusDevDefaultProjectId String?
  birthDate                  DateTime?
  paymentDueDay              Int?
  organizationId             String
  createdAt                  DateTime                @default(now())
  updatedAt                  DateTime                @updatedAt
  activities                 Activity[]
  communications             Communication[]
  contacts                   Contact[]
  conversations              Conversation[]
  organization               Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tags                       CustomerTag[]
  invoices                   Invoice[]
  leads                      Lead[]                  @relation("ConvertedLeads")
  projects                   Project[]
  scheduledInteractions      ScheduledInteraction[]
  tickets                    Ticket[]
  transactions               Transaction[]
  shoppingCarts              AssistantShoppingCart[]
  segments                   MarketSegment[]

  @@unique([email, organizationId])
  @@index([email])
  @@index([status])
  @@index([organizationId])
}

model Communication {
  id             String                 @id @default(cuid())
  customerId     String
  type           CommunicationType
  direction      CommunicationDirection
  subject        String?
  content        String
  metadata       Json?
  createdBy      String?
  organizationId String
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  customer       Customer               @relation(fields: [customerId], references: [id], onDelete: Cascade)
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([organizationId])
  @@index([type])
}

model ScheduledInteraction {
  id          String   @id @default(cuid())
  customerId  String
  type        String   @default("VOICE")
  scheduledAt DateTime
  status      String   @default("PENDING")
  metadata    Json?
  content     String?
  subject     String?
  externalId  String?
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([scheduledAt])
  @@index([status])
  @@index([type])
}

model ReminderTemplate {
  id             String              @id @default(cuid())
  organizationId String
  name           String
  triggerType    ReminderTriggerType
  daysBefore     Int                 @default(0)
  channel        ReminderChannel
  subject        String?
  content        String
  isEnabled      Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([triggerType])
}

model Contact {
  id             String       @id @default(cuid())
  customerId     String
  type           ContactType
  value          String
  displayName    String?
  verified       Boolean      @default(false)
  isPrimary      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  organizationId String
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([type, value])
  @@index([customerId])
  @@index([organizationId])
}

model Lead {
  id             String          @id @default(cuid())
  name           String
  email          String
  phone          String?
  company        String?
  value          Float           @default(0)
  status         String          @default("NEW")
  source         LeadSource      @default(MANUAL)
  score          Int             @default(0)
  notes          String?
  customFields   Json?
  organizationId String
  createdById    String?
  convertedToId  String?
  assignedToId   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  convertedAt    DateTime?
  activities     Activity[]
  jobs           AutomationJob[]
  invoices       Invoice[]
  assignedTo     User?           @relation("AssignedLeads", fields: [assignedToId], references: [id])
  convertedTo    Customer?       @relation("ConvertedLeads", fields: [convertedToId], references: [id])
  createdBy      User?           @relation("CreatedLeads", fields: [createdById], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tags           LeadTag[]

  @@index([email])
  @@index([status])
  @@index([organizationId])
}

model PipelineStage {
  id             String               @id @default(cuid())
  name           String
  order          Int
  color          String               @default("#3B82F6")
  isDefault      Boolean              @default(false)
  organizationId String
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  automations    PipelineAutomation[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
}

model PipelineAutomation {
  id           String          @id @default(cuid())
  stageId      String
  trigger      String          @default("ENTER_STAGE")
  actionType   String
  delayMinutes Int             @default(0)
  config       Json?
  isEnabled    Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  jobs         AutomationJob[]
  stage        PipelineStage   @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([stageId])
}

model AutomationJob {
  id           String             @id @default(cuid())
  automationId String
  leadId       String
  status       String             @default("PENDING")
  scheduledAt  DateTime
  attempts     Int                @default(0)
  error        String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  automation   PipelineAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  lead         Lead               @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([scheduledAt])
}

model Ticket {
  id             String             @id @default(cuid())
  title          String
  description    String?
  status         TicketStatus       @default(OPEN)
  priority       Priority           @default(MEDIUM)
  dueDate        DateTime?
  customerId     String
  assignedToId   String?
  createdById    String?
  taskId         String?
  customFields   Json?
  organizationId String
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  resolvedAt     DateTime?
  activities     Activity[]
  assignedTo     User?              @relation("AssignedTickets", fields: [assignedToId], references: [id])
  createdBy      User?              @relation("CreatedTickets", fields: [createdById], references: [id])
  customer       Customer           @relation(fields: [customerId], references: [id])
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  task           Task?              @relation(fields: [taskId], references: [id])
  attachments    TicketAttachment[]
  comments       TicketComment[]
  tags           TicketTag[]

  @@index([customerId])
  @@index([status])
  @@index([assignedToId])
  @@index([organizationId])
}

model TicketComment {
  id         String   @id @default(cuid())
  ticketId   String
  content    String
  authorId   String?
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  author     User?    @relation(fields: [authorId], references: [id])
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model TicketAttachment {
  id        String   @id @default(cuid())
  ticketId  String
  url       String
  name      String
  type      String
  size      Int
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model Invoice {
  id             String        @id @default(cuid())
  number         String        @unique
  customerId     String?
  leadId         String?
  status         InvoiceStatus @default(DRAFT)
  type           InvoiceType   @default(INVOICE)
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  validUntil     DateTime?
  amount         Float
  subtotal       Float         @default(0)
  tax            Float         @default(0)
  discount       Float         @default(0)
  balance        Float         @default(0)
  currency       String        @default("USD")
  paymentMethod  String?
  terms          String?
  paidAt         DateTime?
  notes          String?
  organizationId String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  customer       Customer?     @relation(fields: [customerId], references: [id])
  lead           Lead?         @relation(fields: [leadId], references: [id])
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items          InvoiceItem[]
  payments       Payment[]

  @@index([customerId])
  @@index([status])
  @@index([organizationId])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitPrice   Float
  total       Float
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id        String        @id @default(cuid())
  invoiceId String
  amount    Float
  method    PaymentMethod
  reference String?
  paidAt    DateTime      @default(now())
  invoice   Invoice       @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
}

model Transaction {
  id             String          @id @default(cuid())
  type           TransactionType
  amount         Float
  currency       String          @default("USD")
  description    String?
  category       String?
  status         String          @default("COMPLETED")
  customerId     String?
  organizationId String
  date           DateTime        @default(now())
  createdAt      DateTime        @default(now())
  customer       Customer?       @relation(fields: [customerId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([date])
  @@index([organizationId])
}

model Conversation {
  id              String             @id @default(cuid())
  sessionId       String             @unique
  platform        Platform
  customerName    String?
  customerContact String
  agentCode       String?
  agentName       String?
  status          ConversationStatus @default(ACTIVE)
  customerId      String?
  organizationId  String
  metadata        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  customer        Customer?          @relation(fields: [customerId], references: [id])
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages        Message[]
  takeover        Takeover?

  @@index([sessionId])
  @@index([customerId])
  @@index([platform])
  @@index([organizationId])
}

model Message {
  id             String        @id @default(cuid())
  conversationId String
  content        String
  sender         MessageSender
  senderName     String?
  mediaUrl       String?
  mediaType      MediaType?
  status         MessageStatus @default(SENT)
  metadata       Json?
  createdAt      DateTime      @default(now())
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

model Takeover {
  id              String       @id @default(cuid())
  conversationId  String       @unique
  takenById       String
  durationMinutes Int          @default(30)
  expiresAt       DateTime
  organizationId  String
  createdAt       DateTime     @default(now())
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Notification {
  id             String           @id @default(cuid())
  userId         String
  type           NotificationType
  title          String
  body           String
  data           Json?
  read           Boolean          @default(false)
  createdAt      DateTime         @default(now())
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([organizationId])
}

model Activity {
  id             String       @id @default(cuid())
  type           ActivityType
  description    String
  userId         String?
  customerId     String?
  leadId         String?
  ticketId       String?
  organizationId String
  metadata       Json?
  createdAt      DateTime     @default(now())
  customer       Customer?    @relation(fields: [customerId], references: [id])
  lead           Lead?        @relation(fields: [leadId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticket         Ticket?      @relation(fields: [ticketId], references: [id])
  user           User?        @relation(fields: [userId], references: [id])

  @@index([customerId])
  @@index([leadId])
  @@index([ticketId])
  @@index([createdAt])
  @@index([organizationId])
}

model Tag {
  id             String        @id @default(cuid())
  name           String
  color          String        @default("#6B7280")
  organizationId String
  createdAt      DateTime      @default(now())
  customers      CustomerTag[]
  leads          LeadTag[]
  tickets        TicketTag[]
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([name, organizationId])
  @@index([organizationId])
}

model CustomerTag {
  customerId String
  tagId      String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([customerId, tagId])
}

model TicketTag {
  ticketId String
  tagId    String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([ticketId, tagId])
}

model LeadTag {
  leadId String
  tagId  String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([leadId, tagId])
}

model Channel {
  id                String       @id @default(cuid())
  name              String
  platform          Platform
  mode              ChannelMode  @default(HYBRID)
  enabled           Boolean      @default(true)
  assistaiAgentCode String?
  autoResumeMinutes Int          @default(30)
  config            Json?
  organizationId    String
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Integration {
  id             String        @id @default(cuid())
  userId         String?
  provider       String
  credentials    Json
  isEnabled      Boolean       @default(true)
  metadata       Json?
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([organizationId])
}

model AiAgent {
  id             String       @id @default(cuid())
  name           String
  description    String?
  provider       AiProvider
  model          String
  systemPrompt   String?
  apiKey         String?
  config         Json?
  isEnabled      Boolean      @default(true)
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          User[]       @relation("AiAgentToUser")

  @@index([organizationId])
  @@index([provider])
}

model PushDevice {
  id             String       @id @default(cuid())
  userId         String
  token          String
  platform       String
  organizationId String
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
}

model NotificationPreferences {
  id             String       @id @default(cuid())
  userId         String       @unique
  email          Boolean      @default(true)
  push           Boolean      @default(true)
  whatsapp       Boolean      @default(true)
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Project {
  id             String          @id @default(cuid())
  name           String
  description    String?
  customerId     String?
  budget         Float           @default(0)
  currency       String          @default("USD")
  status         String          @default("ACTIVE")
  organizationId String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  customer       Customer?       @relation(fields: [customerId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        ProjectMember[]
  tasks          Task[]
  timeLogs       TimeLog[]

  @@index([organizationId])
  @@index([customerId])
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  payRate   Float    @default(0)
  billRate  Float    @default(0)
  role      String   @default("DEV")
  joinedAt  DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
}

model Task {
  id             String        @id @default(cuid())
  projectId      String
  title          String
  description    String?
  status         String        @default("BACKLOG")
  priority       String        @default("MEDIUM")
  assignedToId   String?
  createdById    String
  estimatedHours Float?
  dueDate        DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  assignedTo     User?         @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdBy      User          @relation("CreatedTasks", fields: [createdById], references: [id])
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  comments       TaskComment[]
  tickets        Ticket[]
  timeLogs       TimeLog[]

  @@index([projectId])
  @@index([assignedToId])
  @@index([status])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TimeLog {
  id          String    @id @default(cuid())
  taskId      String?
  projectId   String
  userId      String
  start       DateTime
  end         DateTime?
  description String?
  payRate     Float?
  billRate    Float?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?     @relation(fields: [taskId], references: [id])
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([taskId])
}

model Payout {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  amount         Float
  currency       String       @default("USD")
  month          String
  note           String?
  createdById    String
  createdAt      DateTime     @default(now())
  createdBy      User         @relation("CreatedPayouts", fields: [createdById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([month])
}

model GlobalProduct {
  id             String                      @id @default(cuid())
  name           String
  description    String?
  price          Float
  sku            String                      @unique
  stock          Int                         @default(0)
  imageUrl       String?
  category       String?
  organizationId String
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  cartItems      AssistantShoppingCartItem[]
  organization   Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("global_products")
}

model AssistantShoppingCart {
  id             String                      @id @default(cuid())
  customerId     String
  status         String                      @default("OPEN")
  total          Float                       @default(0)
  organizationId String
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  items          AssistantShoppingCartItem[]
  customer       Customer                    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  organization   Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([organizationId])
  @@map("assistant_shopping_carts")
}

model AssistantShoppingCartItem {
  id             String                @id @default(cuid())
  shoppingCartId String
  productId      String
  quantity       Int
  unitPrice      Float
  total          Float
  createdAt      DateTime              @default(now())
  product        GlobalProduct         @relation(fields: [productId], references: [id], onDelete: Cascade)
  shoppingCart   AssistantShoppingCart @relation(fields: [shoppingCartId], references: [id], onDelete: Cascade)

  @@index([shoppingCartId])
  @@index([productId])
  @@map("assistant_shopping_cart_items")
}

model CalendarEvent {
  id            String   @id @default(cuid())
  userId        String
  summary       String
  description   String?
  start         DateTime
  end           DateTime
  location      String?
  googleEventId String?
  htmlLink      String?
  meetLink      String?
  attendees     Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([start])
}

model ApiKey {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  keyHash        String
  keyPrefix      String
  lastUsedAt     DateTime?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([keyHash])
}

model WebhookEndpoint {
  id             String       @id @default(cuid())
  organizationId String
  url            String
  description    String?
  events         String[]
  isActive       Boolean      @default(true)
  secret         String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model BillingInvoice {
  id              String       @id @default(cuid())
  amount          Float
  currency        String       @default("USD")
  status          String       @default("PAID")
  pdfUrl          String?
  invoiceDate     DateTime     @default(now())
  dueDate         DateTime?
  stripeInvoiceId String?
  organizationId  String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

enum Role {
  ADMIN
  MANAGER
  AGENT
  VIEWER
  SUPER_ADMIN
  DEV
}

enum CommunicationType {
  EMAIL
  WHATSAPP
  NOTE
  CALL
  MEETING
  OTHER
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

enum ReminderTriggerType {
  BIRTHDAY
  PAYMENT_DUE
  CUSTOM_DATE
}

enum ReminderChannel {
  WHATSAPP
  EMAIL
  VOICE
}

enum Plan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum CustomerStatus {
  TRIAL
  ACTIVE
  INACTIVE
  CHURNED
}

enum ContactType {
  EMAIL
  PHONE
  WHATSAPP
  INSTAGRAM
  TELEGRAM
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  MANUAL
  WEBHOOK
  REFERRAL
  ORGANIC
  PAID
  SOCIAL
  ASSISTAI
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum InvoiceType {
  INVOICE
  QUOTE
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  PAYPAL
  CRYPTO
  OTHER
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum Platform {
  WHATSAPP
  INSTAGRAM
  MESSENGER
  ASSISTAI
  WEB
}

enum ConversationStatus {
  ACTIVE
  RESOLVED
  ARCHIVED
}

enum MessageSender {
  USER
  AGENT
  AI
}

enum MediaType {
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
}

enum MessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum NotificationType {
  LEAD
  CLIENT
  TICKET
  MESSAGE
  CONVERSION
  SYSTEM
}

enum ActivityType {
  CREATED
  UPDATED
  DELETED
  STATUS_CHANGE
  ASSIGNMENT
  COMMENT
  EMAIL_SENT
  CALL
  MEETING
  NOTE
  SYSTEM
}

enum ChannelMode {
  AI_ONLY
  HUMAN_ONLY
  HYBRID
}

enum AiProvider {
  OPENAI
  GEMINI
  ELEVENLABS
  ASSISTAI
}

model MarketSegment {
  id             String         @id @default(cuid())
  name           String
  description    String?
  type           String         @default("STATIC") // STATIC or DYNAMIC
  criteria       Json?          // For dynamic segments (e.g. { tags: ["VIP"] })
  organizationId String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customers      Customer[]
  campaigns      Campaign[]

  @@index([organizationId])
}

model Campaign {
  id             String         @id @default(cuid())
  name           String
  subject        String
  content        String         @db.Text
  status         String         @default("DRAFT") // DRAFT, SCHEDULED, SENDING, COMPLETED, FAILED
  scheduledAt    DateTime?
  sentAt         DateTime?
  totalRecipients Int           @default(0)
  sentCount      Int            @default(0)
  failedCount    Int            @default(0)
  segmentId      String?
  organizationId String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  segment        MarketSegment? @relation(fields: [segmentId], references: [id])
  jobs           CampaignJob[]

  @@index([organizationId])
  @@index([status])
}

model CampaignJob {
  id             String         @id @default(cuid())
  campaignId     String
  status         String         @default("PENDING")
  processedCount Int            @default(0)
  totalCount     Int            @default(0)
  error          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  campaign       Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model Reminder {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  triggerType    String        // INVOICE_DUE, BIRTHDAY, CUSTOM_DATE
  offsetDays     Int           @default(0) // -3 = 3 days before, 0 = on day, 3 = 3 days after
  channel        String        // EMAIL, WHATSAPP, SYSTEM
  template       String        @db.Text
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  logs           NotificationLog[]

  @@index([organizationId])
}

model NotificationLog {
  id             String    @id @default(cuid())
  reminderId     String
  customerId     String?
  entityId       String?   // ID of invoice, ticket, etc. that triggered it
  channel        String
  status         String    // SENT, FAILED
  error          String?
  sentAt         DateTime  @default(now())
  reminder       Reminder  @relation(fields: [reminderId], references: [id], onDelete: Cascade)

  @@index([reminderId])
  @@index([customerId])
}
