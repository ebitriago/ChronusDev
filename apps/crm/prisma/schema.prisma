// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ==================== AUTHENTICATION ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // Null if using OAuth only
  name          String
  role          Role      @default(AGENT)
  avatar        String?
  phone         String?
  
  // AssistAI SSO
  assistaiId    String?   @unique
  assistaiToken String?
  
  // Relations
  assignedTickets   Ticket[]    @relation("AssignedTickets")
  createdTickets    Ticket[]    @relation("CreatedTickets")
  createdLeads      Lead[]      @relation("CreatedLeads")
  notifications     Notification[]
  sessions          Session[]
  activities        Activity[]
  integrations      Integration[]
  aiAgents          AiAgent[]
  pushDevices       PushDevice[]
  notifPrefs        NotificationPreferences?
  
  // Project Management (ChronusDev)
  projects        ProjectMember[]
  assignedTasks   Task[]          @relation("AssignedTasks")
  createdTasks    Task[]          @relation("CreatedTasks")
  timeLogs        TimeLog[]
  taskComments    TaskComment[]
  payouts         Payout[]
  createdPayouts  Payout[]    @relation("CreatedPayouts")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Multi-tenancy
  // organizationId - REMOVED single relation
  // organization   - REMOVED single relation
  memberships    OrganizationMember[]
  
  @@index([email])
  @@index([assistaiId])
}

model Organization {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique // for subdomain or url path
  
  // AssistAI Configuration per Tenant
  assistaiConfig Json?    // { apiToken: string, orgCode: string, tenantDomain: string }

  // SaaS Management
  enabledServices String   @default("CRM,CHRONUSDEV,ASSISTAI") // "CRM,CHRONUSDEV,ASSISTAI"

  // Subscription Fields
  plan              String   @default("FREE") // FREE, PRO, ENTERPRISE
  subscriptionStatus String   @default("ACTIVE") // ACTIVE, TRIALING, PAST_DUE, CANCELED
  trialEndsAt       DateTime?
  
  members       OrganizationMember[]
  integrations  Integration[]
  aiAgents      AiAgent[]
  
  // Scoped Data
  customers     Customer[]
  leads         Lead[]
  tickets       Ticket[]
  invoices      Invoice[]
  transactions  Transaction[]
  conversations Conversation[]
  notifications Notification[]
  activities    Activity[]
  tags          Tag[]
  communications Communication[]
  channels      Channel[]
  contacts      Contact[]
  takeovers     Takeover[]
  pushDevices   PushDevice[]
  notifPrefs    NotificationPreferences[]
  payouts       Payout[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Project Management (ChronusDev)
  projects      Project[]
  
  // Automated Reminders
  reminderTemplates ReminderTemplate[]

  // Mini ERP
  globalProducts GlobalProduct[]
  shoppingCarts  AssistantShoppingCart[]
}

model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role         @default(AGENT) // Role within this org
  defaultPayRate Float        @default(0)


  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}



model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([userId])
}

enum Role {
  ADMIN
  MANAGER
  AGENT
  VIEWER
  SUPER_ADMIN
  DEV
}

// ==================== CUSTOMERS ====================

model Customer {
  id              String    @id @default(cuid())
  name            String
  email           String    @unique
  phone           String?
  company         String?
  plan            Plan      @default(FREE)
  status          CustomerStatus @default(TRIAL)
  monthlyRevenue  Float     @default(0)
  currency        String    @default("USD")
  notes           String?
  customFields    Json?
  
  // External IDs
  chronusDevClientId      String?
  chronusDevDefaultProjectId String?
  
  // Reminder dates
  birthDate       DateTime?
  paymentDueDay   Int?       // Day of month (1-28) for recurring billing reminders

  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Relations
  contacts      Contact[]
  tickets       Ticket[]
  invoices      Invoice[]
  leads         Lead[]      @relation("ConvertedLeads")
  conversations Conversation[]
  transactions  Transaction[]
  communications Communication[]
  activities    Activity[]
  tags          CustomerTag[]
  scheduledInteractions ScheduledInteraction[]
  
  // Project Management (ChronusDev)
  projects      Project[]

  // Mini ERP
  shoppingCarts AssistantShoppingCart[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@index([status])
  @@index([organizationId])
}

enum CommunicationType {
  EMAIL
  WHATSAPP
  NOTE
  CALL
  MEETING
  OTHER
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

model Communication {
  id          String    @id @default(cuid())
  customerId  String
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  type        CommunicationType
  direction   CommunicationDirection
  subject     String?
  content     String
  metadata    Json?
  
  createdBy   String?   // User ID or System
  
  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([customerId])
  @@index([organizationId])
  @@index([type])
}

model ScheduledInteraction {
  id          String    @id @default(cuid())
  customerId  String
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  type        String    @default("VOICE") // VOICE, WHATSAPP, EMAIL
  scheduledAt DateTime
  status      String    @default("PENDING") // PENDING, COMPLETED, FAILED
  metadata    Json?     // Context for AI or extras
  
  // Content for non-voice
  content     String?   // Message body
  subject     String?   // Email subject
  
  // Results
  externalId  String?   // Call SID or Message ID
  error       String?

  // Multi-tenancy (implied by Customer, but good to have if querying directly)
  // organizationId String
  // organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([scheduledAt])
  @@index([status])
  @@index([type])
}

// ==================== AUTOMATED REMINDERS ====================

enum ReminderTriggerType {
  BIRTHDAY
  PAYMENT_DUE
  CUSTOM_DATE
}

enum ReminderChannel {
  WHATSAPP
  EMAIL
  VOICE
}

model ReminderTemplate {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name            String        // "Birthday Greeting", "Payment Reminder"
  triggerType     ReminderTriggerType
  daysBefore      Int @default(0)  // Send X days before the date (0 = on the day)
  channel         ReminderChannel
  
  subject         String?       // For EMAIL
  content         String        // Template with placeholders: {{name}}, {{date}}, {{company}}
  
  isEnabled       Boolean @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([organizationId])
  @@index([triggerType])
}

model Contact {
  id          String      @id @default(cuid())
  customerId  String
  customer    Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  type        ContactType
  value       String
  displayName String?
  verified    Boolean     @default(false)
  isPrimary   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@unique([type, value])
  @@index([customerId])
  @@index([organizationId])
}

enum Plan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum CustomerStatus {
  TRIAL
  ACTIVE
  INACTIVE
  CHURNED
}

enum ContactType {
  EMAIL
  PHONE
  WHATSAPP
  INSTAGRAM
  TELEGRAM
}

// ==================== LEADS ====================

model Lead {
  id          String      @id @default(cuid())
  name        String
  email       String
  phone       String?
  company     String?
  value       Float       @default(0)
  status      LeadStatus  @default(NEW)
  source      LeadSource  @default(MANUAL)
  score       Int         @default(0)
  notes       String?
  customFields Json?

  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Relations
  createdById String?
  createdBy   User?       @relation("CreatedLeads", fields: [createdById], references: [id])
  convertedToId String?
  convertedTo Customer?   @relation("ConvertedLeads", fields: [convertedToId], references: [id])
  tags        LeadTag[]
  activities  Activity[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  convertedAt DateTime?
  
  @@index([email])
  @@index([status])
  @@index([organizationId])
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  MANUAL
  WEBHOOK
  REFERRAL
  ORGANIC
  PAID
  SOCIAL
  ASSISTAI
}

// ==================== TICKETS ====================

model Ticket {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TicketStatus @default(OPEN)
  priority    Priority     @default(MEDIUM)
  
  // Relations
  customerId  String
  customer    Customer     @relation(fields: [customerId], references: [id])
  assignedToId String?
  assignedTo  User?        @relation("AssignedTickets", fields: [assignedToId], references: [id])
  createdById String?
  createdBy   User?        @relation("CreatedTickets", fields: [createdById], references: [id])
  
  // Linked Task (ChronusDev Integration)
  taskId      String?
  task        Task?        @relation(fields: [taskId], references: [id])
  
  // Previously just strings, can deprecate or remove. Let's keep for backward compat if needed, or replace.
  // chronusDevTaskId String?
  // chronusDevProjectId String?
  
  customFields Json?

  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Relations
  comments    TicketComment[]
  activities  Activity[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  resolvedAt  DateTime?
  
  @@index([customerId])
  @@index([status])
  @@index([assignedToId])
  @@index([organizationId])
}

model TicketComment {
  id        String   @id @default(cuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  content   String
  authorId  String?
  isInternal Boolean @default(false)
  createdAt DateTime @default(now())
  
  @@index([ticketId])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ==================== INVOICES ====================

model Invoice {
  id          String        @id @default(cuid())
  number      String        @unique
  customerId  String
  customer    Customer      @relation(fields: [customerId], references: [id])
  amount      Float
  currency    String        @default("USD")
  status      InvoiceStatus @default(DRAFT)
  dueDate     DateTime
  paidAt      DateTime?
  notes       String?

  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Relations
  items       InvoiceItem[]
  payments    Payment[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([customerId])
  @@index([status])
  @@index([organizationId])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Int      @default(1)
  unitPrice   Float
  total       Float
  
  @@index([invoiceId])
}

model Payment {
  id          String        @id @default(cuid())
  invoiceId   String
  invoice     Invoice       @relation(fields: [invoiceId], references: [id])
  amount      Float
  method      PaymentMethod
  reference   String?
  paidAt      DateTime      @default(now())
  
  @@index([invoiceId])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  PAYPAL
  CRYPTO
  OTHER
}

// ==================== TRANSACTIONS ====================

model Transaction {
  id          String          @id @default(cuid())
  type        TransactionType
  amount      Float
  currency    String          @default("USD")
  description String?
  category    String?
  status      String          @default("COMPLETED")
  customerId  String?
  customer    Customer?       @relation(fields: [customerId], references: [id])
  
  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  date        DateTime        @default(now())
  createdAt   DateTime        @default(now())
  
  @@index([type])
  @@index([date])
  @@index([organizationId])
}

enum TransactionType {
  INCOME
  EXPENSE
}

// ==================== CONVERSATIONS ====================

model Conversation {
  id              String            @id @default(cuid())
  sessionId       String            @unique
  platform        Platform
  customerName    String?
  customerContact String
  agentCode       String?
  agentName       String?
  status          ConversationStatus @default(ACTIVE)
  
  // Relations
  customerId      String?
  customer        Customer?         @relation(fields: [customerId], references: [id])
  messages        Message[]
  takeover        Takeover?
  
  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  metadata        Json?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([sessionId])
  @@index([customerId])
  @@index([platform])
  @@index([organizationId])
}

model Message {
  id              String        @id @default(cuid())
  conversationId  String
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  content         String
  sender          MessageSender
  senderName      String?
  mediaUrl        String?
  mediaType       MediaType?
  status          MessageStatus @default(SENT)
  metadata        Json?
  
  createdAt       DateTime      @default(now())
  
  @@index([conversationId])
  @@index([createdAt])
}

model Takeover {
  id              String       @id @default(cuid())
  conversationId  String       @unique
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  takenById       String
  durationMinutes Int          @default(30)
  expiresAt       DateTime

  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())
  
  @@index([organizationId])
}

enum Platform {
  WHATSAPP
  INSTAGRAM
  MESSENGER
  ASSISTAI
  WEB
}

enum ConversationStatus {
  ACTIVE
  RESOLVED
  ARCHIVED
}

enum MessageSender {
  USER
  AGENT
  AI
}

enum MediaType {
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
}

enum MessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  body      String
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  // Multi-tenancy (Optional, as user is already scoped, but good for filtering)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([read])
  @@index([organizationId])
}

enum NotificationType {
  LEAD
  CLIENT
  TICKET
  MESSAGE
  CONVERSION
  SYSTEM
}

// ==================== ACTIVITY LOG ====================

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  description String
  
  // Polymorphic relations
  userId      String?
  user        User?        @relation(fields: [userId], references: [id])
  customerId  String?
  customer    Customer?    @relation(fields: [customerId], references: [id])
  leadId      String?
  lead        Lead?        @relation(fields: [leadId], references: [id])
  ticketId    String?
  ticket      Ticket?      @relation(fields: [ticketId], references: [id])

  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  metadata    Json?
  createdAt   DateTime     @default(now())
  
  @@index([customerId])
  @@index([leadId])
  @@index([ticketId])
  @@index([createdAt])
  @@index([organizationId])
}

enum ActivityType {
  CREATED
  UPDATED
  DELETED
  STATUS_CHANGE
  ASSIGNMENT
  COMMENT
  EMAIL_SENT
  CALL
  MEETING
  NOTE
}

// ==================== TAGS ====================

model Tag {
  id          String        @id @default(cuid())
  name        String
  color       String        @default("#6B7280")
  
  // Multi-tenancy
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  customers   CustomerTag[]
  leads       LeadTag[]
  createdAt   DateTime      @default(now())

  @@unique([name, organizationId]) // Tags are unique per org
  @@index([organizationId])
}

model CustomerTag {
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tagId       String
  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([customerId, tagId])
}

model LeadTag {
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tagId       String
  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([leadId, tagId])
}

// ==================== CHANNELS ====================

model Channel {
  id          String       @id @default(cuid())
  name        String
  platform    Platform
  mode        ChannelMode  @default(HYBRID)
  enabled     Boolean      @default(true)
  
  // AssistAI config
  assistaiAgentCode String?
  autoResumeMinutes Int      @default(30)
  
  // Provider config
  config      Json?

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([organizationId])
}

enum ChannelMode {
  AI_ONLY
  HUMAN_ONLY
  HYBRID
}

// ==================== INTEGRATIONS ====================

model Integration {
  id          String   @id @default(cuid())
  userId      String?  // If null, it's system-wide
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider    String   // 'GOOGLE', 'GMAIL', 'ASSISTAI', etc.
  credentials Json     // Stores clientId, clientSecret, etc.
  isEnabled   Boolean  @default(true)
  metadata    Json?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, provider])
  @@index([organizationId])
}

// ==================== AI AGENTS MODULE ====================

enum AiProvider {
  OPENAI
  GEMINI
  ELEVENLABS
}

model AiAgent {
  id              String        @id @default(cuid())
  name            String
  description     String?
  provider        AiProvider
  model           String        // e.g. gpt-4, gemini-pro, eleven_turbo_v2 (voiceId via config)
  systemPrompt    String?       // SQLite handles text automatically
  apiKey          String?       // Optional override, otherwise use env
  config          Json?         // { voiceId, temperature, maxTokens, etc }
  isEnabled       Boolean       @default(true)
  
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  users           User[]        // Created by / Managed by
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([organizationId])
  @@index([provider])
}

model PushDevice {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  token           String
  platform        String
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())
  @@index([userId])
  @@index([organizationId])
}

model NotificationPreferences {
  id              String       @id @default(cuid())
  userId          String       @unique
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  email           Boolean      @default(true)
  push            Boolean      @default(true)
  whatsapp        Boolean      @default(true)
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  @@index([organizationId])
}

// ==================== PROJECT MANAGEMENT (ChronusDev) ====================

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  // Relations
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  
  budget      Float    @default(0)
  currency    String   @default("USD")
  status      String   @default("ACTIVE") // PLANNING, ACTIVE, ON_HOLD, COMPLETED, CANCELLED

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Sub-relations
  members     ProjectMember[]
  tasks       Task[]
  timeLogs    TimeLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([organizationId])
  @@index([customerId])
}

model ProjectMember {
  id          String   @id @default(cuid())
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  payRate     Float    @default(0)
  billRate    Float    @default(0)
  role        String   @default("DEV") // DEV, MANAGER, ADMIN

  joinedAt    DateTime @default(now())
  
  @@unique([projectId, userId])
  @@index([userId])
}

model Task {
  id          String   @id @default(cuid())
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  status      String   @default("BACKLOG") // BACKLOG, TODO, IN_PROGRESS, REVIEW, DONE
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  
  // Assignee
  assignedToId String?
  assignedTo   User?    @relation("AssignedTasks", fields: [assignedToId], references: [id])
  
  createdById  String
  createdBy    User     @relation("CreatedTasks", fields: [createdById], references: [id])

  // Relations
  tickets      Ticket[]
  comments     TaskComment[]
  timeLogs     TimeLog[]
  
  estimatedHours Float?
  dueDate      DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([projectId])
  @@index([assignedToId])
  @@index([status])
}

model TaskComment {
  id        String   @id @default(cuid())
  
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String
  
  createdAt DateTime @default(now())
  
  @@index([taskId])
}

model TimeLog {
  id        String   @id @default(cuid())
  
  taskId    String?
  task      Task?     @relation(fields: [taskId], references: [id])
  
  projectId String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  start     DateTime
  end       DateTime?
  
  description String?
  
  // Snapshot rates at time of log
  payRate   Float?
  billRate  Float?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([projectId])
  @@index([taskId])
}

model Payout {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  amount          Float
  currency        String       @default("USD")
  month           String       // YYYY-MM
  note            String?
  
  createdById     String
  createdBy       User         @relation("CreatedPayouts", fields: [createdById], references: [id])

  createdAt       DateTime     @default(now())
  
  @@index([userId])
  @@index([organizationId])
  @@index([month])
}
  // ... (previous content)

// ==================== MINI ERP (ASSISTAI) ====================

model GlobalProduct {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float
  sku         String   @unique
  stock       Int      @default(0)
  imageUrl    String?
  category    String?
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  cartItems   AssistantShoppingCartItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("global_products")
  @@index([organizationId])
}

model AssistantShoppingCart {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  status      String   @default("OPEN") // OPEN, COMPLETED, ABANDONED
  total       Float    @default(0)
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  items       AssistantShoppingCartItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("assistant_shopping_carts")
  @@index([customerId])
  @@index([organizationId])
}

model AssistantShoppingCartItem {
  id              String                @id @default(cuid())
  shoppingCartId  String
  shoppingCart    AssistantShoppingCart @relation(fields: [shoppingCartId], references: [id], onDelete: Cascade)
  
  productId       String
  product         GlobalProduct         @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  quantity        Int
  unitPrice       Float
  total           Float
  
  createdAt       DateTime @default(now())

  @@map("assistant_shopping_cart_items")
  @@index([shoppingCartId])
  @@index([productId])
}
